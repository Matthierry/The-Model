<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Model</title>
  <meta name="description" content="The Model — Statistical sports betting" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    .filters{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      align-items:end;
      margin:16px 0 18px;
    }
    .field{
      grid-column:span 12;
      background: rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 12px;
    }
    @media (min-width: 900px){
      .field.field-date{grid-column:span 5;}
      .field.field-track{grid-column:span 3;}
      .field.field-grade{grid-column:span 3;}
      .field.field-actions{grid-column:span 1;}
      .field.field-range{grid-column:span 3;}
    }

    .label{
      display:block;
      font-size:12px;
      opacity:0.85;
      margin-bottom:8px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Inputs/buttons */
    .input, .btn, .selectbtn{
      appearance:none;
      -webkit-appearance:none;
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,0.18);
      border-radius:10px;
      padding:10px 12px;
      font:inherit;
      line-height:1.2;
    }
    .input{min-width:160px;}
    .input[type="number"]{width:140px;}
    .input[type="date"]{min-width:170px;}

    .btn, .selectbtn{cursor:pointer; user-select:none; white-space:nowrap;}
    .btn:hover, .selectbtn:hover{border-color: rgba(0,0,0,0.30);}

    .btn.primaryish{
      background: rgba(0,0,0,0.04);
      border-color: rgba(0,0,0,0.20);
    }

    .muted{opacity:0.8; font-size:12px;}

    /* Multi-select dropdown (white background + readable text) */
    .select{position:relative; width:100%;}
    .selectbtn{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#fff;
      color:#111;
    }
    .caret{opacity:0.8; font-size:12px;}

    .panel{
      position:absolute;
      z-index:50;
      top:calc(100% + 8px);
      left:0;
      right:0;
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,0.18);
      border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,0.20);
      padding:10px;
      max-height:320px;
      overflow:auto;
      display:none;
    }
    .panel.open{display:block;}

    .panel .panel-actions{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      position:sticky;
      top:0;
      padding-top:2px;
      background:#fff;
    }
    .chipbtn{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(0,0,0,0.18);
      background: rgba(0,0,0,0.04);
      cursor:pointer;
      color:#111;
    }
    .chipbtn:hover{border-color: rgba(0,0,0,0.28);}

    .opt{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 6px;
      border-radius:10px;
      color:#111;
    }
    .opt:hover{background: rgba(0,0,0,0.04);}
    .opt input{transform: translateY(1px);}

    /* Table */
    .tablewrap{
      border:1px solid rgba(0,0,0,0.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .table-scroll{
      overflow:auto;
      max-height:70vh;
      min-height:260px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:1100px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f3f4f6;
      color:#111;
      border-bottom:1px solid rgba(0,0,0,0.10);
      text-align:left;
      font-size:12px;
      letter-spacing:0.02em;
      padding:10px 12px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(0,0,0,0.06);
      padding:10px 12px;
      font-size:13px;
      white-space:nowrap;
      color:#111;
    }
    tbody tr:hover td{background: rgba(0,0,0,0.03);}

    .table-topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px;
      border-bottom:1px solid rgba(0,0,0,0.08);
      flex-wrap:wrap;
    }

    .summary{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      border:1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.03);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:#111;
      opacity:0.92;
    }

    .pager{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pager .btn{padding:8px 10px; font-size:12px;}
    .pager .pageinfo{font-size:12px; opacity:0.85;}

    .status{margin-top:10px; font-size:12px; opacity:0.85;}
    .error{color:#b00020; opacity:1;}
  </style>
</head>

<body>
  <header>
    <div class="container">
      <nav class="nav" aria-label="Primary">
        <a class="brand" href="index.html">
          <img src="assets/logo.png" alt="The Model logo" />
          <div class="title">
            <strong>The Model</strong>
            <span>Statistical sports betting</span>
          </div>
        </a>
        <div class="menu">
          <a class="navlink" href="selections.html">Selections</a>
          <a class="navlink" href="profit-loss.html">Profit &amp; Loss</a>
          <a class="navlink" href="faqs.html">FAQs</a>
          <a class="navlink" href="contact.html">Contact Us</a>
          <a class="cta primary" href="https://t.co/md5sOV9Pa1" target="_blank" rel="noopener noreferrer">Join Telegram</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="surface">
    <div class="container">
      <section class="section">
        <h2 style="margin-top:0;">Selections</h2>
        <p class="muted">Filter by Date, Track, Grade, Model % and Model Difference. Sorted newest first.</p>

        <div class="filters" aria-label="Filters">
          <div class="field field-date">
            <span class="label">Date (From / To)</span>
            <div class="row">
              <input id="dateFrom" class="input" type="date" aria-label="Date from" />
              <input id="dateTo" class="input" type="date" aria-label="Date to" />
              <span class="muted" id="dateHint"></span>
            </div>
          </div>

          <div class="field field-track">
            <span class="label">Track (multi-select)</span>
            <div class="select" id="trackSelect">
              <button type="button" class="selectbtn" aria-haspopup="listbox" aria-expanded="false" id="trackBtn">
                <span id="trackBtnLabel">All tracks</span>
                <span class="caret">▾</span>
              </button>
              <div class="panel" role="listbox" aria-multiselectable="true" id="trackPanel"></div>
            </div>
          </div>

          <div class="field field-grade">
            <span class="label">Grade (multi-select)</span>
            <div class="select" id="gradeSelect">
              <button type="button" class="selectbtn" aria-haspopup="listbox" aria-expanded="false" id="gradeBtn">
                <span id="gradeBtnLabel">All grades</span>
                <span class="caret">▾</span>
              </button>
              <div class="panel" role="listbox" aria-multiselectable="true" id="gradePanel"></div>
            </div>
          </div>

          <div class="field field-actions">
            <span class="label">Actions</span>
            <div class="row">
              <button type="button" class="btn primaryish" id="resetBtn">Reset</button>
            </div>
          </div>

          <div class="field field-range">
            <span class="label">Model Percentage (E) min / max</span>
            <div class="row">
              <input id="eMin" class="input" type="number" step="0.01" aria-label="Model Percentage min" />
              <input id="eMax" class="input" type="number" step="0.01" aria-label="Model Percentage max" />
            </div>
            <div class="muted" style="margin-top:8px;">Tip: editing these enables filtering</div>
          </div>

          <div class="field field-range">
            <span class="label">Model Difference (F) min / max</span>
            <div class="row">
              <input id="fMin" class="input" type="number" step="0.01" aria-label="Model Difference min" />
              <input id="fMax" class="input" type="number" step="0.01" aria-label="Model Difference max" />
            </div>
            <div class="muted" style="margin-top:8px;">Tip: editing these enables filtering</div>
          </div>
        </div>

        <div class="tablewrap" aria-label="Selections table">
          <div class="table-topbar">
            <div class="summary">
              <span class="pill" id="racesPill">Races: —</span>
              <span class="pill" id="sumMPill">Sum (Col M): —</span>
            </div>

            <div class="pager" aria-label="Pagination">
              <button type="button" class="btn" id="prevBtn">Prev</button>
              <span class="pageinfo" id="pageInfo">Page — of —</span>
              <button type="button" class="btn" id="nextBtn">Next</button>
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead><tr id="theadRow"></tr></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="status" id="status"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="foot">
        <div class="small">© <span id="year"></span> The Model</div>
        <div class="disclaimer">
          Betting involves risk and you can lose money. Content is for informational purposes only and does not guarantee results.
        </div>
      </div>
    </div>
    <script>document.getElementById("year").textContent = new Date().getFullYear();</script>
  </footer>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEHhRjNWX2Eo5dN4euW74cv5WZE8Et-4dfgr2uzScW61xwZmlRntOOfO757QMkSzefUUII4SGtJZZT/pub?gid=643345181&single=true&output=csv";
    const PAGE_SIZE = 200;

    const COLS = {
      A_DATE: 0,
      B_TRACK: 1,
      C_GRADE: 2,
      E_MODEL_PCT: 4,
      F_MODEL_DIFF: 5,
      M_SUM: 12,
    };

    let headers = [];
    let rows = [];
    let filtered = [];
    let page = 1;

    const selectedTracks = new Set();
    const selectedGrades = new Set();

    let dateMin = null;
    let dateMax = null;

    let eMinDefault = null, eMaxDefault = null;
    let fMinDefault = null, fMaxDefault = null;

    // KEY FIX: range filters are NOT active until the user edits them
    let eTouched = false;
    let fTouched = false;

    const statusEl = document.getElementById("status");

    const dateFromEl = document.getElementById("dateFrom");
    const dateToEl   = document.getElementById("dateTo");
    const dateHintEl = document.getElementById("dateHint");

    const eMinEl = document.getElementById("eMin");
    const eMaxEl = document.getElementById("eMax");
    const fMinEl = document.getElementById("fMin");
    const fMaxEl = document.getElementById("fMax");

    const theadRowEl = document.getElementById("theadRow");
    const tbodyEl = document.getElementById("tbody");

    const racesPillEl = document.getElementById("racesPill");
    const sumMPillEl = document.getElementById("sumMPill");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfoEl = document.getElementById("pageInfo");

    const resetBtn = document.getElementById("resetBtn");

    const trackBtn = document.getElementById("trackBtn");
    const trackBtnLabel = document.getElementById("trackBtnLabel");
    const trackPanel = document.getElementById("trackPanel");

    const gradeBtn = document.getElementById("gradeBtn");
    const gradeBtnLabel = document.getElementById("gradeBtnLabel");
    const gradePanel = document.getElementById("gradePanel");

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || "";
      statusEl.classList.toggle("error", !!isError);
    }

    function pad2(n) { return String(n).padStart(2, "0"); }
    function toISODate(d) { return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

    function parseDateLoose(s) {
      if (!s) return null;
      const v = String(s).trim();
      const iso = v.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (iso) {
        const y = +iso[1], m = +iso[2], d = +iso[3];
        const dt = new Date(Date.UTC(y, m - 1, d));
        return isNaN(dt) ? null : dt;
      }
      const uk = v.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
      if (uk) {
        const d = +uk[1], m = +uk[2], y = +uk[3];
        const dt = new Date(Date.UTC(y, m - 1, d));
        return isNaN(dt) ? null : dt;
      }
      const t = Date.parse(v);
      if (Number.isNaN(t)) return null;
      const dt = new Date(t);
      return new Date(Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate()));
    }

    function parseCSV(text) {
      const out = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (inQuotes) {
          if (ch === '"' && next === '"') { cur += '"'; i++; }
          else if (ch === '"') { inQuotes = false; }
          else { cur += ch; }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ",") { row.push(cur); cur = ""; }
          else if (ch === "\n") { row.push(cur); out.push(row); row = []; cur = ""; }
          else if (ch === "\r") {}
          else { cur += ch; }
        }
      }
      row.push(cur);
      out.push(row);
      if (out.length && out[out.length - 1].every(c => String(c).trim() === "")) out.pop();
      return out;
    }

    function toNumber(s) {
      if (s === null || s === undefined) return NaN;
      const v = String(s).trim();
      if (v === "") return NaN;
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function computeMinMaxNumeric(colIdx) {
      let min = Infinity, max = -Infinity, count = 0;
      for (const r of rows) {
        const n = toNumber(r[colIdx]);
        if (Number.isFinite(n)) {
          count++;
          if (n < min) min = n;
          if (n > max) max = n;
        }
      }
      if (count === 0) return { min: null, max: null, count: 0 };
      return { min, max, count };
    }

    function computeDateMinMax() {
      let min = null, max = null;
      for (const r of rows) {
        const dt = parseDateLoose(r[COLS.A_DATE]);
        if (!dt) continue;
        if (!min || dt < min) min = dt;
        if (!max || dt > max) max = dt;
      }
      return { min, max };
    }

    function uniqueSortedValues(colIdx) {
      const set = new Set();
      for (const r of rows) {
        const v = String(r[colIdx] ?? "").trim();
        if (v) set.add(v);
      }
      return Array.from(set).sort((a,b) => a.localeCompare(b, undefined, { sensitivity:"base" }));
    }

    function setPanelOpen(panel, btn, open) {
      panel.classList.toggle("open", open);
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    }

    function closePanelsIfClickedOutside(e) {
      const t = e.target;
      if (!document.getElementById("trackSelect").contains(t)) setPanelOpen(trackPanel, trackBtn, false);
      if (!document.getElementById("gradeSelect").contains(t)) setPanelOpen(gradePanel, gradeBtn, false);
    }

    function updateMultiSelectLabel(values, selectedSet, btnLabelEl, allLabel) {
      if (selectedSet.size === 0 || selectedSet.size === values.length) btnLabelEl.textContent = allLabel;
      else if (selectedSet.size === 1) btnLabelEl.textContent = Array.from(selectedSet)[0];
      else btnLabelEl.textContent = `${selectedSet.size} selected`;
    }

    function renderMultiSelect(panel, values, selectedSet, btnLabelEl, allLabel) {
      panel.innerHTML = "";

      const actions = document.createElement("div");
      actions.className = "panel-actions";

      const selAll = document.createElement("button");
      selAll.type = "button";
      selAll.className = "chipbtn";
      selAll.textContent = "Select all";
      selAll.addEventListener("click", () => {
        selectedSet.clear();
        values.forEach(v => selectedSet.add(v));
        updateMultiSelectLabel(values, selectedSet, btnLabelEl, allLabel);
        applyFiltersAndRender(true);
      });

      const clear = document.createElement("button");
      clear.type = "button";
      clear.className = "chipbtn";
      clear.textContent = "Clear";
      clear.addEventListener("click", () => {
        selectedSet.clear();
        updateMultiSelectLabel(values, selectedSet, btnLabelEl, allLabel);
        applyFiltersAndRender(true);
      });

      actions.appendChild(selAll);
      actions.appendChild(clear);
      panel.appendChild(actions);

      values.forEach(v => {
        const opt = document.createElement("label");
        opt.className = "opt";
        opt.setAttribute("role", "option");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selectedSet.has(v);
        cb.addEventListener("change", () => {
          if (cb.checked) selectedSet.add(v); else selectedSet.delete(v);
          updateMultiSelectLabel(values, selectedSet, btnLabelEl, allLabel);
          applyFiltersAndRender(true);
        });

        const txt = document.createElement("span");
        txt.textContent = v;

        opt.appendChild(cb);
        opt.appendChild(txt);
        panel.appendChild(opt);
      });

      updateMultiSelectLabel(values, selectedSet, btnLabelEl, allLabel);
    }

    function renderTableHeader() {
      theadRowEl.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        theadRowEl.appendChild(th);
      });
    }

    function renderTableBody() {
      tbodyEl.innerHTML = "";

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (page > totalPages) page = totalPages;

      const start = (page - 1) * PAGE_SIZE;
      const end = Math.min(filtered.length, start + PAGE_SIZE);
      const pageRows = filtered.slice(start, end);

      for (const r of pageRows) {
        const tr = document.createElement("tr");
        for (let i = 0; i < headers.length; i++) {
          const td = document.createElement("td");
          td.textContent = r[i] ?? "";
          tr.appendChild(td);
        }
        tbodyEl.appendChild(tr);
      }

      pageInfoEl.textContent = `Page ${page} of ${totalPages}`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;
    }

    function updateSummary() {
      let sum = 0;
      for (const r of filtered) {
        const n = toNumber(r[COLS.M_SUM]);
        if (Number.isFinite(n)) sum += n;
      }
      racesPillEl.textContent = `Races: ${filtered.length.toLocaleString()}`;
      sumMPillEl.textContent = `Sum (Col M): ${sum.toFixed(2)}`;
    }

    function getRange(minEl, maxEl) {
      const minStr = String(minEl.value ?? "").trim();
      const maxStr = String(maxEl.value ?? "").trim();
      const minVal = minStr === "" ? NaN : Number(minStr);
      const maxVal = maxStr === "" ? NaN : Number(maxStr);
      const apply = Number.isFinite(minVal) && Number.isFinite(maxVal);
      return { apply, minVal, maxVal };
    }

    function applyFiltersAndRender(resetToFirstPage = false) {
      if (resetToFirstPage) page = 1;

      const fromVal = dateFromEl.value ? parseDateLoose(dateFromEl.value) : null;
      const toVal   = dateToEl.value ? parseDateLoose(dateToEl.value) : null;

      const eRange = getRange(eMinEl, eMaxEl);
      const fRange = getRange(fMinEl, fMaxEl);

      const tracksAll = (selectedTracks.size === 0);
      const gradesAll = (selectedGrades.size === 0);

      filtered = rows.filter(r => {
        const dt = parseDateLoose(r[COLS.A_DATE]);
        if (fromVal && dt && dt < fromVal) return false;
        if (toVal && dt && dt > toVal) return false;

        const track = String(r[COLS.B_TRACK] ?? "").trim();
        const grade = String(r[COLS.C_GRADE] ?? "").trim();
        if (!tracksAll && !selectedTracks.has(track)) return false;
        if (!gradesAll && !selectedGrades.has(grade)) return false;

        // KEY FIX: only filter E/F after the user has touched those inputs
        if (eTouched && eRange.apply) {
          const e = toNumber(r[COLS.E_MODEL_PCT]);
          if (!Number.isFinite(e)) return false;
          if (e < eRange.minVal || e > eRange.maxVal) return false;
        }

        if (fTouched && fRange.apply) {
          const f = toNumber(r[COLS.F_MODEL_DIFF]);
          // If F is non-numeric, keep row unless you want strict filtering
          if (Number.isFinite(f)) {
            if (f < fRange.minVal || f > fRange.maxVal) return false;
          }
        }

        return true;
      });

      filtered.sort((a,b) => {
        const da = parseDateLoose(a[COLS.A_DATE]);
        const db = parseDateLoose(b[COLS.A_DATE]);
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return db - da;
      });

      updateSummary();
      renderTableBody();
    }

    function resetAll() {
      dateFromEl.value = "";
      dateToEl.value = "";

      selectedTracks.clear();
      selectedGrades.clear();

      // Reset touched flags so page shows ALL rows again
      eTouched = false;
      fTouched = false;

      // Repopulate inputs with min/max, but they won't filter until edited
      if (eMinDefault !== null && eMaxDefault !== null) {
        eMinEl.value = eMinDefault.toFixed(2);
        eMaxEl.value = eMaxDefault.toFixed(2);
      } else {
        eMinEl.value = "";
        eMaxEl.value = "";
      }

      if (fMinDefault !== null && fMaxDefault !== null) {
        fMinEl.value = fMinDefault.toFixed(2);
        fMaxEl.value = fMaxDefault.toFixed(2);
      } else {
        fMinEl.value = "";
        fMaxEl.value = "";
      }

      const trackValues = uniqueSortedValues(COLS.B_TRACK);
      const gradeValues = uniqueSortedValues(COLS.C_GRADE);
      updateMultiSelectLabel(trackValues, selectedTracks, trackBtnLabel, "All tracks");
      updateMultiSelectLabel(gradeValues, selectedGrades, gradeBtnLabel, "All grades");

      applyFiltersAndRender(true);
    }

    async function init() {
      try {
        setStatus("Loading table…");
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load CSV (${res.status})`);
        const text = await res.text();

        const grid = parseCSV(text);
        if (!grid.length) throw new Error("CSV appears to be empty.");

        headers = grid[0].slice(0, 13).map(h => String(h || "").trim());
        rows = grid.slice(1).map(r => r.slice(0, 13));

        renderTableHeader();

        const dmm = computeDateMinMax();
        dateMin = dmm.min;
        dateMax = dmm.max;
        if (dateMin && dateMax) dateHintEl.textContent = `Data range: ${toISODate(dateMin)} → ${toISODate(dateMax)}`;

        const em = computeMinMaxNumeric(COLS.E_MODEL_PCT);
        eMinDefault = em.min;
        eMaxDefault = em.max;

        const fm = computeMinMaxNumeric(COLS.F_MODEL_DIFF);
        fMinDefault = fm.min;
        fMaxDefault = fm.max;

        // Populate inputs but DO NOT enable filtering until user edits
        eTouched = false;
        fTouched = false;

        if (eMinDefault !== null && eMaxDefault !== null) {
          eMinEl.value = eMinDefault.toFixed(2);
          eMaxEl.value = eMaxDefault.toFixed(2);
        } else {
          eMinEl.value = "";
          eMaxEl.value = "";
        }

        if (fMinDefault !== null && fMaxDefault !== null) {
          fMinEl.value = fMinDefault.toFixed(2);
          fMaxEl.value = fMaxDefault.toFixed(2);
        } else {
          fMinEl.value = "";
          fMaxEl.value = "";
        }

        const trackValues = uniqueSortedValues(COLS.B_TRACK);
        const gradeValues = uniqueSortedValues(COLS.C_GRADE);
        renderMultiSelect(trackPanel, trackValues, selectedTracks, trackBtnLabel, "All tracks");
        renderMultiSelect(gradePanel, gradeValues, selectedGrades, gradeBtnLabel, "All grades");

        // Show ALL rows by default
        filtered = rows.slice();
        filtered.sort((a,b) => {
          const da = parseDateLoose(a[COLS.A_DATE]);
          const db = parseDateLoose(b[COLS.A_DATE]);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return db - da;
        });

        updateSummary();
        renderTableBody();

        setStatus(`Loaded ${rows.length.toLocaleString()} rows.`);
      } catch (err) {
        console.error(err);
        setStatus(err.message || "Something went wrong loading the table.", true);
      }
    }

    // Events
    trackBtn.addEventListener("click", () => {
      const isOpen = trackPanel.classList.contains("open");
      setPanelOpen(trackPanel, trackBtn, !isOpen);
      setPanelOpen(gradePanel, gradeBtn, false);
    });
    gradeBtn.addEventListener("click", () => {
      const isOpen = gradePanel.classList.contains("open");
      setPanelOpen(gradePanel, gradeBtn, !isOpen);
      setPanelOpen(trackPanel, trackBtn, false);
    });

    document.addEventListener("click", closePanelsIfClickedOutside);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        setPanelOpen(trackPanel, trackBtn, false);
        setPanelOpen(gradePanel, gradeBtn, false);
      }
    });

    [dateFromEl, dateToEl].forEach(el => el.addEventListener("change", () => applyFiltersAndRender(true)));

    // Mark range filters as "touched" only when user edits them
    [eMinEl, eMaxEl].forEach(el => {
      el.addEventListener("input", () => { eTouched = true; applyFiltersAndRender(true); });
      el.addEventListener("change", () => { eTouched = true; applyFiltersAndRender(true); });
    });
    [fMinEl, fMaxEl].forEach(el => {
      el.addEventListener("input", () => { fTouched = true; applyFiltersAndRender(true); });
      el.addEventListener("change", () => { fTouched = true; applyFiltersAndRender(true); });
    });

    prevBtn.addEventListener("click", () => { page = Math.max(1, page - 1); renderTableBody(); });
    nextBtn.addEventListener("click", () => {
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      page = Math.min(totalPages, page + 1);
      renderTableBody();
    });

    resetBtn.addEventListener("click", resetAll);

    init();
  </script>
</body>
</html>
